# Логика мульти-сбора данных (1→3) — архитектура MVP

## Слой источников (ingestion.adapters)

На первом уровне собираются данные из разных источников Telegram с помощью адаптеров. Планируется реализовать несколько типов адаптеров:

- **BotAdapter** – подключается к открытым чатам (или чатам, куда можно добавить бота). Используется на этапе MVP.
- **UserAdapterSecondary** – работает через клиент Telegram (например, Telethon/Pyrogram) от лица второго пользовательского аккаунта. Позволяет читать приватные чаты, куда бот добавиться не может.
- **UserAdapterPrimary** – аналогично, но от лица основного аккаунта, для чтения «супер-закрытых» чатов, доступных только основному пользователю.

Все адаптеры реализуют общий интерфейс (например, методы `subscribe(chat_id)` и `fetch_updates(since)`), и каждый соблюдает собственные лимиты и алгоритмы экспоненциального бэкоффа при опросе API.

## Роутер источников (ingestion.router)

Роутер управляет потоком данных от разных адаптеров согласно конфигурации. Основные функции роутера:

- Включает необходимые адаптеры на основе конфигурационного файла и применяет **список разрешённых чатов** (allow-list) для каждого источника, чтобы обрабатывать только указанные чаты.
- Выполняет дедупликацию входящих сообщений по ключу, составленному из атрибутов сообщения: `{source_type, chat_id, message_id, hash(text)}`. Это предотвращает повторную обработку дублей одного и того же контента.

## Конвейер нормализации (pipeline)

После сбора сырые сообщения проходят через конвейер обработки и обогащения данных:

- **Шаги обработки.** Сначала выполняется обнаружение тикеров и токенов в тексте сообщения. Затем по найденным тикерам осуществляется разрешение контрактного адреса (CA) через внешние сети (с приоритетом на Base, затем Ethereum и т.д.). Далее сообщение обогащается сведениями о токене: рыночная капитализация (mcap), ликвидность, Fully Diluted Value (FDV), возраст проекта и пр. После обогащения применяются фильтры антиспама и анализ тональности (sentiment). На заключительном этапе сообщение классифицируется в одну из категорий приоритетности: «Срочно», «На рассмотрение» или «Спорные».
- **Гибкая настройка правил.** Формулы и пороговые значения для вычислений (рейтинг коллеров, чатов, «всплески» активности и др.) не зашиты в коде. Они хранятся в конфигурации (например, `config.formulas` в формате JSON/YAML в базе данных) и могут быть изменены без перезапуска сервиса. Предусмотрены специальные команды бота для корректировки этих параметров, например: `/spikesedit 5 3 3` (пример изменения порогов детектирования всплесков).

## Отправка уведомлений (Notifier)

Обработанные сообщения превращаются в удобные уведомления («карточки») и доставляются пользователю:

- Создаётся приватный Telegram-канал для получателя с включёнными темами (threads). Уведомления падают в разные темы в зависимости от категории: в тему **«Срочно»** отправляются критически важные алерты, в **«Рассмотреть»** – сообщения для обзора, в **«Спорные»** – потенциально сомнительный или спорный контент. Отдельно выделяется тема для сети Solana (например, тема **«Sol»**), куда складываются уведомления, связанные с этой сетью.
- Реализуется два режима доставки: **моментальные уведомления** для категории «Срочно» и **пакетные дайджесты** для прочих. Дайджесты формируются раз в 4 часа или раз в сутки (настраивается) и содержат суммарную информацию, тогда как срочные сообщения доставляются сразу в реальном времени.

## Лимиты и устойчивость системы

Для стабильной работы система учитывает ограничения Telegram API и сетевых запросов, а также предусматривает восстановление после ошибок:

- У каждого типа источника настроены свои квоты и интервалы опроса. Например, для Bot API запросы могут выполняться каждые 1–2 минуты, а для пользовательских адаптеров – каждые 3–5 минут. При всплеске активности адаптер может кратковременно увеличить частоту опроса (**burst**), после чего автоматически уходит в режим снижения нагрузки (**cooldown**) чтобы избежать превышения лимитов.
- Сообщения обрабатываются через внутренние очереди с хранением в памяти, что позволяет повторять попытки обработки (retry) в случае неудач. Ведётся мониторинг «здоровья» каждого источника: отслеживаются ошибки, коды ответа 429 (Too Many Requests), события `FloodWait` и прочие сигналы проблем. Если источник начинает работать нестабильно или превышает лимиты, он может быть автоматически приостановлен до восстановления нормальной работы.

## База данных: минимальный состав таблиц

Для хранения конфигурации, исторических данных и результатов работы конвейера используется база данных. Ниже описаны основные таблицы и ключевые поля (минимально необходимые):

- **sources** – `id`, `type` (тип источника: bot, user_secondary, user_primary), `status`, `rate_policy` (политика лимитов/скорости опроса).
- **accounts** – `id`, `label` (название/метка аккаунта), `adapter_type` (тип адаптера, которому принадлежит аккаунт), `session_ref` (ссылка на зашифрованную сессию), `2FA_hint` (подсказка для двухфакторной аутентификации, если применимо).
- **chats** – `chat_id`, `title` (название чата), `username` (юзернейм или публичный алиас, если есть), `network_scope` (сеть/экосистема, например enum: base, eth, sol), `tier` (уровень доступа: primary или secondary), `is_enabled` (флаг активности мониторинга этого чата).
- **chat_source_map** – соответствие источников чатам: поля `(source_id, chat_id, enabled)` показывают, какой источник следит за каким чатом и включён ли сбор.
- **messages** – `msg_id`, `chat_id`, `source_id`, `ts` (временная метка сообщения), `author_id`/`username` автора, `text` (текст сообщения), `media_flags` (признаки наличия медиа-контента), `parsed_tokens[]` (извлечённые токены/тикеры или другие сущности, выявленные при парсинге).
- **tokens** – сведения о токенах: `ca` (контрактный адрес), `chain` (блокчейн/сеть), `symbol` (тикер), `mcap` (рыночная капитализация), `fdv` (Fully Diluted Value), `liq` (ликвидность), `age` (возраст проекта), `last_seen` (время последнего упоминания), `quality_flags` (флаги качества токена, напр. пометки: honeypot?, proxy?, renounce? и т.д.).
- **callers** – информация о «коллерах» (авторах сигналов): `user_id` или `username`, статистика `stats` – например, количество сигналов `calls_total`, показатели успешности `wins_2x/5x/10x`, `avg_gain`, `% atH`, `freshness_3m/6m/12m`.
- **ratings** – рейтинг различных сущностей: `entity_type`, `entity_id`, `score`, `breakdown_json`, `ts`.
- **config** – конфигурационные данные: `key`, `json`.
- **jobs** – информация о фоновых заданиях: `type`, `last_run`, `status`, `logs_ref`.

## Конфигурационные флаги функциональности

- На этапе MVP активирован только бот-адаптер: `features.ingestion.bot = on`. Другие типы сбора отключены: `features.ingestion.user_secondary = off`, `features.ingestion.user_primary = off`.
- Для последующего включения новых источников потребуется лишь добавить учетные данные необходимых аккаунтов и переключить соответствующий флаг в конфиге на `on`.

## Безопасность сессий пользовательских адаптеров

- Файлы сессий (`.session` файлы Telethon/Pyrogram) должны храниться только в зашифрованном виде (Fernet/age). Ключ шифрования хранится в ENV. Права доступа 600. Отдельный системный пользователь, включена 2FA. На сервере – UFW, fail2ban.
- Разные адаптеры запускаются в отдельных процессах для изоляции.

## Команды бота

- MVP: `/callers 30`, `/spikesedit a b c`, `/last`, `/help`.
- Позже: `/sources`, `/addchat <chat_id> <source>`, `/rmchat <chat_id>`, пагинация `/callers next`.

## Парсинг карточек конкурентов

- Два паттерна: короткие алерты и полные карточки.
- Нормализация чисел (с/без запятых), извлечение ссылок на DEX.

## Этапы реализации

### Этап 0 (сейчас)

- Список открытых чатов для MVP.
- Внести правки в ТЗ (источники/БД/безопасность/команды/лимиты), чек-листы запуска.

### Этап 1 (MVP, BotAdapter)

- Поднять бота, привязать открытые чаты, включить allow-list.
- Настроить формулы в config.
- Проверить команды и доставку в приватный канал с ветками.

### Этап 2 (read-only тест вторичного юзер-акка)

- Получить api_id/api_hash, авторизовать второй аккаунт, зашифровать сессию.
- Включить `features.ingestion.user_secondary = on` для 1–2 чатов с опросом 5 мин.

### Этап 3 (точечное включение основного юзер-акка)

- Минимальный набор «супер-закрытых» чатов, жёсткий allow-list.
- Первые 48ч без алертов, затем дозированная доставка.
